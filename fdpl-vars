echo "... Set vars"

SCRIPT=$(basename $0)

# parameters for build and install
ARCH=amd64
DIST=bookworm
# During install, root password is copied.
# Take default if there is no root password.
DEFAULT_ROOT_PASSWORD=debian

# New hostnames
NEW_BUILD_HOSTNAME=$(hostname)-build
NEW_INSTALL_HOSTNAME=$(hostname)-cloned

# Folders, files
FDPL_FOLDER=/root/fdpl-debian
MOUNT_FOLDER=/mnt/fdpl-debian
TARFILE=fdpl-debian-$DIST-$ARCH.tar
LB_FOLDER_NAME=lb
LOCAL_FOLDER_NAME=local
LOG_FOLDER_NAME=log
LOG_FILE_BASENAME=$SCRIPT.$EPOCHSECONDS.log
LOCAL_CONF_FILE=fdpl-debian.local.conf
# Generated names
LB_FOLDER=$FDPL_FOLDER/$LB_FOLDER_NAME
LOCAL_FOLDER=$FDPL_FOLDER/$LOCAL_FOLDER_NAME
LOG_FOLDER=$FDPL_FOLDER/$LOG_FOLDER_NAME
LOGFILE=$LOG_FOLDER/$LOG_FILE_BASENAME
NEW_FDPL_FOLDER=$MOUNT_FOLDER/.$FDPL_FOLDER
NEW_LB_FOLDER=$MOUNT_FOLDER/.$LB_FOLDER
NEW_LOCAL_FOLDER=$MOUNT_FOLDER/.$LOCAL_FOLDER
NEW_LOG_FOLDER=$MOUNT_FOLDER/.$LOG_FOLDER
NEW_LOGFILE=$NEW_LOG_FOLDER/$LOG_FILE_BASENAME

# GIT branch for updates
BRANCH=main   # can use local.conf override for own branch

### init scripts ###

function die() {
	echo "$@"
	exit 1
}

if [ "$USER" != "root" ]; then
  die "Not root, needed for building Live Debian"
fi

# Get local configuration
if [ -e $FDPL_FOLDER/$LOCAL_CONF_FILE ]; then
  if [ -z "$FIRST_LOCAL_CONF" ]; then
    echo "...... Set local vars from $LOCAL_CONF_FILE"
    source $FDPL_FOLDER/$LOCAL_CONF_FILE
    FIRST_LOCAL_CONF=done
  fi
else
  echo "...... No $LOCAL_CONF_FILE local config file"
  echo "...... Create a default one"
  echo "# Default $LOCAL_CONF_FILE file" >$FDPL_FOLDER/$LOCAL_CONF_FILE
  cat <<end-of-local-conf-file >>$FDPL_FOLDER/$LOCAL_CONF_FILE
# Parameters for build and install
ARCH=amd64
DIST=bookworm
# GIT branch for updates
BRANCH=main
end-of-local-conf-file
fi

# GIT repo for updates
URL=https://github.com/tecoboot/fdpl-debian/archive/refs/heads/$BRANCH.zip

mkdir -p $LOG_FOLDER
